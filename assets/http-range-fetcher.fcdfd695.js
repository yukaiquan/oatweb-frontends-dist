import{g as S}from"./@babel.d3038ccc.js";import{b as d}from"./buffer.66f81d03.js";import{q as _}from"./quick-lru.2e8f10dc.js";import{o as E}from"./object.entries-ponyfill.1bb02ccd.js";import{g as w}from"./rollup-plugin-node-polyfills.285eab2e.js";import{A as T,a as D}from"./abortcontroller-polyfill.e0408538.js";import{_ as x}from"./@jbrowse.1c1f30ba.js";import{l as p}from"./window-or-global.776535f1.js";function z(f){if(typeof f!="string")return{};const e={};return f.toLowerCase().replace(/(?:^|(?:\s*,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(a,r,n,s)=>{const i=n||s;return e[r]=i?i.toLowerCase():!0,""})?{}:(Object.keys(e).forEach(a=>{if(/^[\d]+$/.test(e[a]))try{const r=parseInt(e[a],10);Number.isNaN(r)||(e[a]=r)}catch{}}),e)}class A{constructor({minimumTTL:e}){this.minimumTTL=e}calculateChunkExpirationDate(e){const{headers:t={},requestDate:a,responseDate:r}=e;let n=r||a;if(!n){if(!t.date)return;n=new Date(t.date)}const s=c=>new Date(n.getTime()+c);if(/\bno-cache\b/.test(t.pragma))return s(this.minimumTTL);const i=z(t["cache-control"]);if(i["no-cache"]||i["no-store"]||i["must-revalidate"])return s(this.minimumTTL);if(i["max-age"]!==void 0){const c=i["max-age"]*1e3;return s(Math.max(c,this.minimumTTL))}else{if(this._coerceToDate(t.expires))return this._coerceToDate(t.expires);if(this._coerceToDate(t["last-modified"])){const c=this._coerceToDate(t["last-modified"]),o=(n.getTime()-c.getTime())/10;return s(o)}}}_coerceToDate(e){if(e){if(e instanceof Date)return e;if(typeof e=="string"||typeof e=="number")return new Date(e)}}cachedChunkIsValid(e){const t=this.calculateChunkExpirationDate(e);return!t||new Date<=t}chunkIsCacheable(){return!0}}var m=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof w<"u")return w;throw new Error("unable to locate global object")};let $=typeof m().AbortController>"u"?T:m().AbortController;typeof m().AbortController>"u"?D:m().AbortSignal;class y{constructor({frequency:e=100,fetch:t,maxExtraSize:a=32e3,maxFetchSize:r=1e6}){this.requestQueues={},this.fetchCallback=t,this.frequency=e,this.maxExtraSize=a,this.maxFetchSize=r}_canAggregate(e,t){return t.start<=e.end+this.maxExtraSize&&t.end-t.start+e.end-e.start<this.maxFetchSize}_allSignalsFired(e){return new Promise(t=>{let a=e.filter(r=>!r.aborted).length;e.forEach(r=>{r.addEventListener("abort",()=>{a-=1,a||t()})})}).catch(t=>{console.error(t)})}_dispatch({url:e,start:t,end:a,requests:r}){const n=new $,s=[];r.forEach(({requestOptions:i})=>{i&&i.signal&&s.push(i.signal)}),s.length===r.length&&this._allSignalsFired(s).then(()=>n.abort()),this.fetchCallback(e,t,a-1,{signal:n.signal}).then(i=>{const c=i.buffer;r.forEach(({start:o,end:l,resolve:h})=>{h({headers:i.headers,buffer:c.slice(o-t,l-t)})})},i=>{r.forEach(({reject:c})=>c(i))})}_aggregateAndDispatch(){E(this.requestQueues).forEach(([e,t])=>{if(!t||!t.length)return;const a=[];if(t.forEach(n=>{const{requestOptions:s,reject:i}=n;s&&s.signal&&s.signal.aborted?i(Object.assign(new Error("aborted"),{code:"ERR_ABORTED"})):a.push(n)}),a.sort((n,s)=>n.start-s.start),t.length=0,!a.length)return;let r;for(let n=0;n<a.length;n+=1){const s=a[n];r&&this._canAggregate(r,s)?(r.requests.push(s),r.end=s.end):(r&&this._dispatch(r),r={requests:[s],url:e,start:s.start,end:s.end})}r&&this._dispatch(r)})}_enQueue(e,t){this.requestQueues[e]||(this.requestQueues[e]=[]),this.requestQueues[e].push(t)}fetch(e,t,a,r={}){return new Promise((n,s)=>{this._enQueue(e,{start:t,end:a,resolve:n,reject:s,requestOptions:r}),this.timeout||(this.timeout=setTimeout(()=>{this.timeout=void 0,this._aggregateAndDispatch()},this.frequency||1))})}}const C=(...f)=>x(()=>import("./node-fetch.e4febff4.js"),["assets/node-fetch.e4febff4.js","assets/stream-browserify.c9806a5a.js","assets/readable-stream.b9ecb3ea.js","assets/@gmod.89422c98.js","assets/buffer.66f81d03.js","assets/base64-js.db0f5df9.js","assets/ieee754.6e84f04f.js","assets/abortable-promise-cache.7cb58d6d.js","assets/@babel.d3038ccc.js","assets/abortcontroller-polyfill.e0408538.js","assets/quick-lru.2e8f10dc.js","assets/pako.ae457f40.js","assets/buffer-crc32.64f36e84.js","assets/@jkbonfield.580cc4c5.js","assets/bzip2.7acc0326.js","assets/md5.e4ed9555.js","assets/crypt.894faad3.js","assets/charenc.26816e87.js","assets/is-buffer.30be6946.js","assets/long.81b4bfdc.js","assets/cross-fetch.5e5fd403.js","assets/generic-filehandle.a92b52fd.js","assets/object.entries-ponyfill.1bb02ccd.js","assets/binary-parser.62cc4542.js","assets/rxjs.bbb58625.js","assets/string_decoder.54c7d31f.js","assets/safe-buffer.d6407320.js","assets/inherits.0b103347.js","assets/util-deprecate.7e67cde4.js","assets/whatwg-url.842f27a2.js","assets/webidl-conversions.f65defb4.js","assets/tr46.15fa4192.js"]).then(({default:e})=>e(...f));async function k(f,e,t,a={}){p.fetch||(p.fetch=C);const r=new Date,n=Object.assign({method:"GET",headers:{range:`bytes=${e}-${t}`}},a),s=await C(f,n),i=new Date;if(s.status!==206&&s.status!==200)throw new Error(`HTTP ${s.status} when fetching ${f} bytes ${e}-${t}`);if(s.status===200)throw new Error(`HTTP ${s.status} when fetching ${f} bytes ${e}-${t}`);const c=await s.arrayBuffer().then(o=>d.Buffer.from(o));return{headers:s.headers.map,requestDate:r,responseDate:i,buffer:c}}function I(f){return f.name==="AbortError"||f.code==="ERR_ABORTED"||!!f.message.match(/\b(aborted|AbortError)\b/i)}class R{constructor({fetch:e=k,size:t=1e7,chunkSize:a=32768,aggregationTime:r=100,minimumTTL:n=1e3,maxFetchSize:s=a*4,maxExtraFetch:i=a}){this.aggregator=new y({fetch:e,frequency:r,maxFetchSize:s,maxExtraSize:i}),this.chunkSize=a,this.chunkCache=new _({maxSize:Math.floor(t/a)||1}),this.cacheSemantics=new A({minimumTTL:n}),this.stats=new _({maxSize:20})}async getRange(e,t=0,a,r={}){let n=a;if(n===void 0){const h=await this.stat(e);if(h.size===void 0)throw new Error("length not specified, and could not determine size of the remote file");n=h.size-t}const s=Math.floor(t/this.chunkSize),i=Math.floor((t+n-1)/this.chunkSize),c=new Array(i-s+1);for(let h=s;h<=i;h+=1)c[h-s]=this._getChunk(e,h,r).then(u=>u&&{headers:u.headers,buffer:u.buffer,chunkNumber:h});let o=await Promise.all(c);if(o=o.filter(h=>!!h),!o.length)return{headers:{},buffer:d.Buffer.allocUnsafe(0)};const l=t-o[0].chunkNumber*this.chunkSize;return{headers:this._makeHeaders(o[0].headers,t,t+n-1),buffer:this._makeBuffer(o,l,n)}}_makeBuffer(e,t,a){if(e.length===1)return e[0].buffer.slice(t,t+a);if(e.length===0)return d.Buffer.allocUnsafe(0);const r=e.map(c=>c.buffer),n=r.shift().slice(t);let s=r.pop(),i=n.length+r.reduce((c,o)=>c+o.length,0)+s.length-a;return i<0&&(i=0),s=s.slice(0,s.length-i),d.Buffer.concat([n,...r,s])}async stat(e){let t=this.stats.get(e);if(!t){const a=await this._getChunk(e,0);if(this._recordStatsIfNecessary(e,a),t=this.stats.get(e),!t)throw new Error(`failed to retrieve file size for ${e}`)}return t}_headersToStats(e){const{headers:t}=e,a={};if(t["content-range"]){const r=t["content-range"].match(/\d+-\d+\/(\d+)/);r&&(a.size=parseInt(r[1],10),Number.isNaN(a.size)&&delete a.size)}return t["last-modified"]&&(a.mtime=new Date(t["last-modified"]),a.mtime.toString()==="Invalid Date"&&delete a.mtime,a.mtime&&(a.mtimeMs=a.mtime.getTime())),a}_makeHeaders(e,t,a){const r=Object.assign({},e||{});r["content-length"]=a-t;const s=(r["content-range"]||"").match(/\d+-\d+\/(\d+)/);return s&&(r["content-range"]=`${t}-${a-1}/${s[1]}`,r["x-resource-length"]=s[1]),r}async _getChunk(e,t,a){const r=`${e}/${t}`,n=this.chunkCache.get(r);if(n){let u,g;try{u=await n}catch(b){if(I(b))g=!0;else throw b}return g||!this.cacheSemantics.cachedChunkIsValid(u)?(this._uncacheIfSame(r,n),this._getChunk(e,t,a)):(this._recordStatsIfNecessary(e,u),u)}const s=t*this.chunkSize;let i=s+this.chunkSize;const c=this.stats.get(e);if(c&&c.size){if(s>=c.size)return;i>=c.size&&(i=c.size)}let o=!1;const l=this.aggregator.fetch(e,s,i,a).catch(u=>{throw o=!0,this._uncacheIfSame(r,l),u});o||this.chunkCache.set(r,l);const h=await l;return this._recordStatsIfNecessary(e,h),this.cacheSemantics.chunkIsCacheable(h)||this._uncacheIfSame(r,l),h}_recordStatsIfNecessary(e,t){this.stats.has(e)||this.stats.set(e,this._headersToStats(t))}_uncacheIfSame(e,t){this.chunkCache.get(e)===t&&this.chunkCache.delete(e)}reset(){this.stats.clear(),this.chunkCache.clear()}}const P=Object.freeze(Object.defineProperty({__proto__:null,HttpRangeFetcher:R},Symbol.toStringTag,{value:"Module"})),Q=S(P);export{Q as r};
